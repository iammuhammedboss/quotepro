<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Export Quotation #<%= quotation.quotation_no %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/images/quotepro-logo.png">
  
  <style>
    body { font-family: 'Outfit', sans-serif; }
    
    .export-panel {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 24px;
      color: white;
      margin-bottom: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .settings-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
    }
    
    .settings-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .settings-header {
      font-size: 18px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    /* ‚úÖ OPTIMIZED: Better preview frame */
    .preview-frame {
      border: 3px solid #e5e7eb;
      border-radius: 12px;
      background: white;
      min-height: 800px; /* Increased height */
      position: sticky;
      top: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    }
    
    .export-btn {
      background: linear-gradient(135deg, #10b981 0%, #047857 100%);
      color: white;
      padding: 16px 32px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .export-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }
    
    .export-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .method-card {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .method-card:hover {
      border-color: #3b82f6;
      background: #f0f9ff;
    }
    
    .method-card.selected {
      border-color: #10b981;
      background: #f0fdf4;
    }
    
    .range-input {
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      border-radius: 3px;
      background: #e5e7eb;
      outline: none;
    }
    
    .range-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
    }
    
    .checkbox-card {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .checkbox-card:hover {
      border-color: #3b82f6;
      background: #f0f9ff;
    }
    
    .checkbox-card.checked {
      border-color: #10b981;
      background: #f0fdf4;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      transition: width 0.3s ease;
    }
    
    /* ‚úÖ Modal styles */
    .modal-overlay {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
    }
    
    .whatsapp-frame {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    
    /* ‚úÖ Letterhead preview */
    .letterhead-preview {
      background: linear-gradient(45deg, #f8fafc, #f1f5f9);
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>
<body class="bg-gray-50">

<!-- Header -->
<div class="bg-red-700 text-white px-6 py-4 flex justify-between items-center">
  <div class="flex items-center gap-4">
    <img src="/images/quotepro-logo-white.png" class="h-10" />
    <div>
      <h1 class="text-xl font-bold">QuotePro ‚Äì Export Quotation</h1>
      <p class="text-sm">Professional Export Interface</p>
    </div>
  </div>
  
  <div class="flex gap-3">
    <a href="/quotations/view/<%= quotation.id %>" class="bg-white text-red-700 px-3 py-2 rounded hover:bg-gray-200 text-sm font-medium">
      üëÅÔ∏è View
    </a>
    <a href="/quotations/search" class="bg-white text-red-700 px-3 py-2 rounded hover:bg-gray-200 text-sm font-medium">
      üîç Search
    </a>
    <a href="/dashboard" class="bg-white text-red-700 px-3 py-2 rounded hover:bg-gray-200 text-sm font-medium">
      üè† Dashboard
    </a>
  </div>
</div>

<div class="max-w-[1600px] mx-auto p-6"> <!-- ‚úÖ Wider container -->
  
  <!-- Main Export Panel -->
  <div class="export-panel">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-3xl font-bold mb-2">üöÄ Export Quotation</h2>
        <p class="text-blue-100 text-lg">Quotation #<%= quotation.quotation_no %> - <%= quotation.client_name %></p>
        <p class="text-blue-200 text-sm">Total: OMR <%= parseFloat(quotation.grand_total).toFixed(3) %></p>
      </div>
      <div class="text-right">
        <div class="text-6xl mb-2">üìÑ</div>
        <p class="text-sm text-blue-200">Professional Export</p>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 xl:grid-cols-5 gap-6"> <!-- ‚úÖ Better grid proportions -->
    
    <!-- Settings Panel -->
    <div class="xl:col-span-3 space-y-6">
      
      <!-- File Type & Paper Settings -->
      <div class="settings-card">
        <div class="settings-header">
          <span class="text-2xl">üìÑ</span>
          <span>File Type & Paper Settings</span>
        </div>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-3">File Type</label>
            <div class="grid grid-cols-4 gap-3">
              <div class="method-card selected" data-type="pdf">
                <div class="text-2xl mb-2">üìÑ</div>
                <div class="text-sm font-medium">PDF</div>
              </div>
              <div class="method-card" data-type="excel">
                <div class="text-2xl mb-2">üìä</div>
                <div class="text-sm font-medium">Excel</div>
              </div>
              <div class="method-card" data-type="png">
                <div class="text-2xl mb-2">üñºÔ∏è</div>
                <div class="text-sm font-medium">PNG</div>
              </div>
              <div class="method-card" data-type="jpg">
                <div class="text-2xl mb-2">üì∑</div>
                <div class="text-sm font-medium">JPG</div>
              </div>
            </div>
          </div>
          
          <div id="paperSettings">
            <label class="block text-sm font-medium text-gray-700 mb-3">Paper & Quality</label>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <select id="paperType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <option value="plain">Plain Paper</option>
                  <option value="draft">Draft Quality</option>
                  <option value="letterhead-main">üìã Letterhead - Main</option>
                  <option value="letterhead-alt">üìã Letterhead - Alternative</option>
                  <option value="letterhead-premium">üìã Letterhead - Premium</option>
                </select>
              </div>
              <div>
                <select id="paperSize" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <option value="A4">A4 (210√ó297mm)</option>
                  <option value="Letter">Letter (216√ó279mm)</option>
                  <option value="Legal">Legal (216√ó356mm)</option>
                  <option value="A3">A3 (297√ó420mm)</option>
                </select>
              </div>
            </div>
            
            <!-- ‚úÖ Letterhead Preview -->
            <div id="letterheadPreview" class="hidden letterhead-preview">
              <div class="text-2xl mb-2">üìã</div>
              <div class="text-sm text-gray-600">Letterhead will be applied as background</div>
              <div class="text-xs text-gray-500 mt-2">Your quotation content will overlay on the letterhead image</div>
            </div>
          </div>
          
          <div id="imageSettings" class="hidden space-y-3">
            <label class="block text-sm font-medium text-gray-700">Image Quality</label>
            <div class="flex items-center gap-3">
              <input type="range" id="imageQuality" class="range-input flex-1" min="60" max="100" value="90">
              <span id="imageQualityValue" class="text-sm font-medium text-gray-600 min-w-12">90%</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Header Customization -->
      <div class="settings-card">
        <div class="settings-header">
          <span class="text-2xl">‚úèÔ∏è</span>
          <span>Header Customization</span>
        </div>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Main Heading</label>
            <select id="customHeader" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="QUOTATION FOR WATERPROOFING">Quotation for Waterproofing</option>
              <option value="QUOTATION FOR EPOXY WORKS">Quotation for Epoxy Works</option>
              <option value="QUOTATION FOR PAINTING WORKS">Quotation for Painting Works</option>
              <option value="QUOTATION FOR CONSTRUCTION">Quotation for Construction</option>
              <option value="QUOTATION FOR MAINTENANCE">Quotation for Maintenance</option>
              <option value="CUSTOM">Custom Heading...</option>
            </select>
          </div>
          
          <div id="customHeaderInput" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Custom Heading</label>
            <input type="text" id="customHeaderText" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter custom heading...">
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Header Font Size</label>
              <div class="flex items-center gap-3">
                <input type="range" id="headerFontSize" class="range-input flex-1" min="24" max="36" value="28">
                <span id="headerFontSizeValue" class="text-sm font-medium text-gray-600 min-w-12">28px</span>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">QR Code Size</label>
              <div class="flex items-center gap-3">
                <input type="range" id="qrSize" class="range-input flex-1" min="80" max="150" value="100">
                <span id="qrSizeValue" class="text-sm font-medium text-gray-600 min-w-12">100px</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Signature & Stamp -->
      <div class="settings-card">
        <div class="settings-header">
          <span class="text-2xl">‚úçÔ∏è</span>
          <span>Signature & Stamp</span>
        </div>
        
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div class="checkbox-card" id="signatureCard">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="includeSignature" class="w-5 h-5 text-blue-600 rounded">
                <div>
                  <div class="font-medium text-gray-900">Add Signature</div>
                  <div class="text-sm text-gray-500">Digital signature</div>
                </div>
              </div>
            </div>
            <div class="checkbox-card" id="stampCard">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="includeStamp" class="w-5 h-5 text-blue-600 rounded">
                <div>
                  <div class="font-medium text-gray-900">Add Stamp</div>
                  <div class="text-sm text-gray-500">Company stamp</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Export Method -->
      <div class="settings-card">
        <div class="settings-header">
          <span class="text-2xl">üöÄ</span>
          <span>Export Method</span>
        </div>
        
        <div class="space-y-4">
          <div class="grid grid-cols-3 gap-4">
            <div class="method-card selected" data-method="download">
              <div class="text-3xl mb-2">‚¨áÔ∏è</div>
              <div class="font-medium">Download</div>
              <div class="text-xs text-gray-500 mt-1">Save to device</div>
            </div>
            <div class="method-card" data-method="email">
              <div class="text-3xl mb-2">üìß</div>
              <div class="font-medium">Email</div>
              <div class="text-xs text-gray-500 mt-1">Send via email</div>
            </div>
            <div class="method-card" data-method="whatsapp">
              <div class="text-3xl mb-2">üí¨</div>
              <div class="font-medium">WhatsApp</div>
              <div class="text-xs text-gray-500 mt-1">Share on WhatsApp</div>
            </div>
          </div>
          
          <!-- ‚úÖ Enhanced Email Configuration -->
          <div id="emailConfig" class="hidden space-y-3 bg-blue-50 p-4 rounded-lg">
            <div class="font-medium text-blue-800 mb-2">üìß Email Configuration</div>
            <div class="grid grid-cols-2 gap-3">
              <input type="email" id="emailTo" placeholder="Recipient email..." class="px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <input type="text" id="emailSubject" placeholder="Email subject..." class="px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <textarea id="emailBody" rows="3" placeholder="Email message..." class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>
          
          <!-- ‚úÖ Enhanced WhatsApp Configuration -->
          <div id="whatsappConfig" class="hidden space-y-3 bg-green-50 p-4 rounded-lg">
            <div class="font-medium text-green-800 mb-2">üí¨ WhatsApp Configuration</div>
            <div class="grid grid-cols-2 gap-3">
              <input type="tel" id="whatsappPhone" placeholder="Phone number..." class="px-3 py-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
              <select id="whatsappTemplate" class="px-3 py-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                <option value="professional">Professional Template</option>
                <option value="simple">Simple Template</option>
                <option value="detailed">Detailed Template</option>
              </select>
            </div>
            <div class="text-xs text-green-600">üì± Phone format: +968XXXXXXXX</div>
          </div>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="settings-card">
        <div class="flex gap-4">
          <button id="previewBtn" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-700 transition-colors">
            üëÅÔ∏è Preview
          </button>
          <button id="exportBtn" class="export-btn flex-2">
            üöÄ Export Now
          </button>
        </div>
        
        <div id="exportProgress" class="hidden mt-4">
          <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
            <span id="progressText">Preparing export...</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
          </div>
        </div>
      </div>
      
    </div>
    
    <!-- ‚úÖ OPTIMIZED: Better Preview Panel -->
    <div class="xl:col-span-2">
      <div class="settings-card h-full">
        <div class="settings-header">
          <span class="text-2xl">üëÅÔ∏è</span>
          <span>Live Preview</span>
          <div class="ml-auto flex gap-2">
            <button id="fullscreenBtn" class="text-sm bg-gray-100 px-3 py-1 rounded hover:bg-gray-200">
              ‚õ∂ Fullscreen
            </button>
            <button id="refreshPreviewBtn" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">
              üîÑ Refresh
            </button>
          </div>
        </div>
        
        <div class="preview-frame">
          <iframe id="previewFrame" src="/quotations/export/<%= quotation.id %>/preview" class="w-full h-full border-0 rounded-lg"></iframe>
        </div>
      </div>
    </div>
    
  </div>
</div>

<!-- ‚úÖ Enhanced WhatsApp Modal -->
<div id="whatsappModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded-xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-auto shadow-2xl">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-green-700">üì± WhatsApp Integration</h2>
      <button id="closeWhatsappModal" class="text-gray-500 hover:text-gray-700 text-3xl transition-colors">&times;</button>
    </div>
    
    <div class="space-y-6">
      <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded-r-lg">
        <h3 class="font-medium text-green-800 mb-3">üìù How to Share:</h3>
        <ol class="text-sm text-green-700 space-y-2">
          <li><strong>Step 1:</strong> Document will download automatically</li>
          <li><strong>Step 2:</strong> WhatsApp Web will open in new tab</li>
          <li><strong>Step 3:</strong> Find contact: <strong><%= quotation.client_name %> (<%= quotation.client_phone || 'N/A' %>)</strong></li>
          <li><strong>Step 4:</strong> Attach the downloaded document</li>
          <li><strong>Step 5:</strong> Use the caption provided below</li>
        </ol>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="space-y-4">
          <h4 class="font-medium text-gray-800">üìé Document Info:</h4>
          <div class="bg-gray-50 p-4 rounded-lg">
            <div class="text-sm space-y-1">
              <div><strong>File:</strong> <span id="downloadFileName">quotation.pdf</span></div>
              <div><strong>Size:</strong> <span id="downloadFileSize">~1.2 MB</span></div>
              <div><strong>Type:</strong> Professional PDF</div>
            </div>
          </div>
          
          <div class="flex gap-3">
            <button id="downloadForWhatsApp" class="flex-1 bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors">
              üì• Download Document
            </button>
            <button id="openWhatsApp" class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">
              üí¨ Open WhatsApp
            </button>
          </div>
        </div>
        
        <div class="space-y-4">
          <h4 class="font-medium text-gray-800">üìù Message Caption:</h4>
          <div class="bg-gray-50 p-4 rounded-lg">
            <textarea id="whatsappCaption" readonly class="w-full h-40 text-xs text-gray-700 bg-transparent border-0 resize-none" style="font-family: monospace;">üìã *QUOTATION DETAILS*

üè¢ *Client:* <%= quotation.client_name %>
üì± *Phone:* <%= quotation.client_phone || 'N/A' %>
üìç *Location:* <%= quotation.project_location || 'N/A' %>
üí∞ *Total Amount:* OMR <%= parseFloat(quotation.grand_total).toFixed(3) %>
üìÖ *Date:* <%= new Date(quotation.tdate).toLocaleDateString('en-GB') %>
üî¢ *Quote No:* <%= quotation.quotation_no %>

üíß *International Pipes Technology Co LLC*
üåê Your Waterproofing Specialist

üìû Contact: +968 96030210
‚úâÔ∏è Email: eurotechoman.iptc@gmail.com</textarea>
          </div>
          
          <button id="copyCaption" class="w-full bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">
            üìã Copy Caption
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Fullscreen Preview Modal -->
<div id="fullscreenModal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50">
  <div class="w-full h-full p-4 flex flex-col">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-white text-xl font-bold">üìÑ Fullscreen Preview</h3>
      <button id="closeFullscreen" class="text-white hover:text-gray-300 text-3xl">&times;</button>
    </div>
    <div class="flex-1 bg-white rounded-lg overflow-hidden">
      <iframe id="fullscreenFrame" class="w-full h-full border-0"></iframe>
    </div>
  </div>
</div>

<script>
// Global state
let currentSettings = {
  customHeader: 'QUOTATION FOR WATERPROOFING',
  headerFontSize: '28px',
  bodyFontSize: '14px',
  tableFontSize: '12px',
  smallFontSize: '11px',
  qrSize: '100',
  fileType: 'pdf',
  paperType: 'plain',
  paperSize: 'A4',
  imageQuality: 90,
  includeSignature: false,
  includeStamp: false,
  stampPosition: 'auto',
  exportMethod: 'download'
};

let currentDocument = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  initializeEventListeners();
  updatePreview();
});

function initializeEventListeners() {
  // Header customization
  document.getElementById('customHeader').addEventListener('change', function() {
    const value = this.value;
    const customInput = document.getElementById('customHeaderInput');
    
    if (value === 'CUSTOM') {
      customInput.classList.remove('hidden');
      currentSettings.customHeader = document.getElementById('customHeaderText').value || 'CUSTOM HEADING';
    } else {
      customInput.classList.add('hidden');
      currentSettings.customHeader = value;
    }
    updatePreview();
  });
  
  document.getElementById('customHeaderText').addEventListener('input', function() {
    currentSettings.customHeader = this.value || 'CUSTOM HEADING';
    updatePreview();
  });
  
  // Font size sliders
  const sliders = ['headerFontSize', 'bodyFontSize', 'tableFontSize', 'smallFontSize', 'qrSize', 'imageQuality'];
  sliders.forEach(slider => {
    const element = document.getElementById(slider);
    const valueSpan = document.getElementById(slider + 'Value');
    
    element.addEventListener('input', function() {
      const value = this.value;
      const unit = slider.includes('FontSize') ? 'px' : (slider === 'qrSize' ? 'px' : '%');
      
      currentSettings[slider] = value + (slider.includes('FontSize') || slider === 'qrSize' ? 'px' : '');
      valueSpan.textContent = value + unit;
      
      if (slider !== 'imageQuality') {
        updatePreview();
      }
    });
  });
  
  // File type selection
  document.querySelectorAll('[data-type]').forEach(card => {
    card.addEventListener('click', function() {
      document.querySelectorAll('[data-type]').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
      
      currentSettings.fileType = this.dataset.type;
      
      // Show/hide relevant settings
      const paperSettings = document.getElementById('paperSettings');
      const imageSettings = document.getElementById('imageSettings');
      
      if (currentSettings.fileType === 'png' || currentSettings.fileType === 'jpg') {
        paperSettings.classList.add('hidden');
        imageSettings.classList.remove('hidden');
      } else if (currentSettings.fileType === 'excel') {
        paperSettings.classList.add('hidden');
        imageSettings.classList.add('hidden');
      } else {
        paperSettings.classList.remove('hidden');
        imageSettings.classList.add('hidden');
      }
    });
  });
  
  // Paper settings
  document.getElementById('paperType').addEventListener('change', function() {
    currentSettings.paperType = this.value;
    
    // Show/hide letterhead preview
    const letterheadPreview = document.getElementById('letterheadPreview');
    if (this.value.includes('letterhead')) {
      letterheadPreview.classList.remove('hidden');
    } else {
      letterheadPreview.classList.add('hidden');
    }
    
    updatePreview();
  });
  
  document.getElementById('paperSize').addEventListener('change', function() {
    currentSettings.paperSize = this.value;
    updatePreview();
  });
  
  // Signature and stamp
  const signatureCard = document.getElementById('signatureCard');
  const stampCard = document.getElementById('stampCard');
  const signatureCheckbox = document.getElementById('includeSignature');
  const stampCheckbox = document.getElementById('includeStamp');
  
  signatureCard.addEventListener('click', function() {
    signatureCheckbox.checked = !signatureCheckbox.checked;
    this.classList.toggle('checked', signatureCheckbox.checked);
    currentSettings.includeSignature = signatureCheckbox.checked;
    updatePreview();
  });
  
  stampCard.addEventListener('click', function() {
    stampCheckbox.checked = !stampCheckbox.checked;
    this.classList.toggle('checked', stampCheckbox.checked);
    currentSettings.includeStamp = stampCheckbox.checked;
    updatePreview();
  });
  
  // Export method selection
  document.querySelectorAll('[data-method]').forEach(card => {
    card.addEventListener('click', function() {
      document.querySelectorAll('[data-method]').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
      
      currentSettings.exportMethod = this.dataset.method;
      
      // Show/hide relevant configurations
      document.getElementById('emailConfig').classList.toggle('hidden', currentSettings.exportMethod !== 'email');
      document.getElementById('whatsappConfig').classList.toggle('hidden', currentSettings.exportMethod !== 'whatsapp');
      
      // Pre-fill email/whatsapp fields
      if (currentSettings.exportMethod === 'email') {
        document.getElementById('emailTo').value = '<%= quotation.client_email || "" %>';
        document.getElementById('emailSubject').value = `Quotation <%= quotation.quotation_no %> - <%= quotation.client_name %>`;
        document.getElementById('emailBody').value = `Dear <%= quotation.client_name %>,\n\nPlease find attached your quotation for the requested services.\n\nBest regards,\nInternational Pipes Technology Co LLC`;
      } else if (currentSettings.exportMethod === 'whatsapp') {
        document.getElementById('whatsappPhone').value = '<%= quotation.client_phone || "" %>';
      }
    });
  });
  
  // Preview buttons
  document.getElementById('previewBtn').addEventListener('click', updatePreview);
  document.getElementById('refreshPreviewBtn').addEventListener('click', updatePreview);
  
  // Fullscreen preview
  document.getElementById('fullscreenBtn').addEventListener('click', openFullscreenPreview);
  document.getElementById('closeFullscreen').addEventListener('click', closeFullscreenPreview);
  
  // Export button
  document.getElementById('exportBtn').addEventListener('click', handleExport);
  
  // WhatsApp modal
  document.getElementById('closeWhatsappModal').addEventListener('click', closeWhatsAppModal);
  document.getElementById('downloadForWhatsApp').addEventListener('click', downloadForWhatsApp);
  document.getElementById('openWhatsApp').addEventListener('click', openWhatsApp);
  document.getElementById('copyCaption').addEventListener('click', copyCaption);
}

function updatePreview() {
  const previewFrame = document.getElementById('previewFrame');
  
  // Create form data with current settings
  const formData = new FormData();
  Object.keys(currentSettings).forEach(key => {
    formData.append(key, currentSettings[key]);
  });
  
  // Update preview via POST to maintain settings
  fetch(`/quotations/export/<%= quotation.id %>/preview`, {
    method: 'POST',
    body: formData
  })
  .then(response => response.text())
  .then(html => {
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    previewFrame.src = url;
    
    // Update fullscreen frame if open
    const fullscreenFrame = document.getElementById('fullscreenFrame');
    if (fullscreenFrame.src) {
      fullscreenFrame.src = url;
    }
  })
  .catch(err => {
    console.error('Preview error:', err);
  });
}

function openFullscreenPreview() {
  const modal = document.getElementById('fullscreenModal');
  const fullscreenFrame = document.getElementById('fullscreenFrame');
  const previewFrame = document.getElementById('previewFrame');
  
  fullscreenFrame.src = previewFrame.src;
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function closeFullscreenPreview() {
  const modal = document.getElementById('fullscreenModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

function handleExport() {
  const exportBtn = document.getElementById('exportBtn');
  const progressDiv = document.getElementById('exportProgress');
  const progressText = document.getElementById('progressText');
  const progressPercent = document.getElementById('progressPercent');
  const progressFill = document.getElementById('progressFill');
  
  // Disable button and show progress
  exportBtn.disabled = true;
  progressDiv.classList.remove('hidden');
  
  let progress = 0;
  const progressInterval = setInterval(() => {
    progress += Math.random() * 20;
    if (progress > 90) progress = 90;
    
    progressPercent.textContent = Math.round(progress) + '%';
    progressFill.style.width = progress + '%';
    
    if (progress < 30) {
      progressText.textContent = 'Preparing document...';
    } else if (progress < 60) {
      progressText.textContent = 'Generating ' + currentSettings.fileType.toUpperCase() + '...';
    } else {
      progressText.textContent = 'Finalizing export...';
    }
  }, 200);
  
  // Prepare form data with additional settings
  const formData = new FormData();
  Object.keys(currentSettings).forEach(key => {
    formData.append(key, currentSettings[key]);
  });
  
  // Add email/whatsapp specific data
  if (currentSettings.exportMethod === 'email') {
    formData.append('emailTo', document.getElementById('emailTo').value);
    formData.append('emailSubject', document.getElementById('emailSubject').value);
    formData.append('emailBody', document.getElementById('emailBody').value);
  } else if (currentSettings.exportMethod === 'whatsapp') {
    formData.append('whatsappPhone', document.getElementById('whatsappPhone').value);
    formData.append('whatsappTemplate', document.getElementById('whatsappTemplate').value);
  }
  
  // Make export request
  fetch(`/quotations/export/<%= quotation.id %>/generate`, {
    method: 'POST',
    body: formData
  })
  .then(response => {
    clearInterval(progressInterval);
    progressPercent.textContent = '100%';
    progressFill.style.width = '100%';
    progressText.textContent = 'Export complete!';
    
    if (currentSettings.exportMethod === 'download') {
      return response.blob().then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = getFileName();
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    } else {
      return response.json();
    }
  })
  .then(data => {
    if (data && data.action === 'email') {
      handleEmailExport(data.emailData);
    } else if (data && data.action === 'whatsapp') {
      handleWhatsAppExport(data.whatsappData);
    }
    
    // Reset UI
    setTimeout(() => {
      exportBtn.disabled = false;
      progressDiv.classList.add('hidden');
      progressFill.style.width = '0%';
    }, 2000);
  })
  .catch(err => {
    console.error('Export error:', err);
    clearInterval(progressInterval);
    exportBtn.disabled = false;
    progressDiv.classList.add('hidden');
    progressText.textContent = 'Export failed';
    alert('Export failed: ' + err.message);
  });
}

function getFileName() {
  const quotationNo = '<%= quotation.quotation_no %>'.replace(/[^a-zA-Z0-9]/g, '-');
  const clientName = '<%= quotation.client_name %>'.replace(/[^a-zA-Z0-9]/g, '-').substring(0, 20);
  const date = new Date().toISOString().slice(0, 10);
  const extension = currentSettings.fileType === 'excel' ? 'xlsx' : currentSettings.fileType;
  
  return `${quotationNo}-${clientName}-${date}.${extension}`;
}

function handleEmailExport(emailData) {
  // Enhanced email handling with attachment support
  const emailUrl = `mailto:${emailData.to}?subject=${encodeURIComponent(emailData.subject)}&body=${encodeURIComponent(emailData.body)}`;
  
  // Open email client
  window.open(emailUrl);
  
  // Also trigger download since we can't attach files to mailto
  setTimeout(() => {
    handleExport(); // This will download the file
    alert('üìß Email client opened! Please attach the downloaded file manually.');
  }, 1000);
}

function handleWhatsAppExport(whatsappData) {
  currentDocument = whatsappData.document;
  
  // Update modal with document info
  document.getElementById('downloadFileName').textContent = whatsappData.document.filename;
  document.getElementById('downloadFileSize').textContent = `~${Math.round(whatsappData.document.content.length * 0.75 / 1024)} KB`;
  
  // Show WhatsApp modal
  document.getElementById('whatsappModal').classList.remove('hidden');
  document.getElementById('whatsappModal').classList.add('flex');
}

function closeWhatsAppModal() {
  document.getElementById('whatsappModal').classList.add('hidden');
  document.getElementById('whatsappModal').classList.remove('flex');
}

function downloadForWhatsApp() {
  if (!currentDocument) {
    alert('No document available. Please export first.');
    return;
  }
  
  // Convert base64 to blob
  const byteCharacters = atob(currentDocument.content);
  const byteNumbers = new Array(byteCharacters.length);
  for (let i = 0; i < byteCharacters.length; i++) {
    byteNumbers[i] = byteCharacters.charCodeAt(i);
  }
  const byteArray = new Uint8Array(byteNumbers);
  const blob = new Blob([byteArray], { type: currentDocument.contentType });
  
  // Create download
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = currentDocument.filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  // Show success message
  document.getElementById('downloadForWhatsApp').innerHTML = '‚úÖ Downloaded!';
  setTimeout(() => {
    document.getElementById('downloadForWhatsApp').innerHTML = 'üì• Download Document';
  }, 3000);
}

function openWhatsApp() {
  const phone = document.getElementById('whatsappPhone').value || '<%= quotation.client_phone || "" %>';
  let whatsappUrl = 'https://web.whatsapp.com/';
  
  if (phone) {
    // Format phone number (remove non-digits and add country code if needed)
    const cleanPhone = phone.replace(/\D/g, '');
    const formattedPhone = cleanPhone.startsWith('968') ? cleanPhone : '968' + cleanPhone;
    whatsappUrl = `https://web.whatsapp.com/send?phone=${formattedPhone}`;
  }
  
  window.open(whatsappUrl, '_blank');
}

function copyCaption() {
  const caption = document.getElementById('whatsappCaption');
  caption.select();
  document.execCommand('copy');
  
  // Show success message
  document.getElementById('copyCaption').innerHTML = '‚úÖ Copied!';
  setTimeout(() => {
    document.getElementById('copyCaption').innerHTML = 'üìã Copy Caption';
  }, 2000);
  
  // Also copy to clipboard API if available
  if (navigator.clipboard) {
    navigator.clipboard.writeText(caption.value);
  }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey || e.metaKey) {
    switch(e.key) {
      case 'p':
        e.preventDefault();
        updatePreview();
        break;
      case 'e':
        e.preventDefault();
        handleExport();
        break;
      case 'f':
        e.preventDefault();
        openFullscreenPreview();
        break;
    }
  }
  
  // ESC to close modals
  if (e.key === 'Escape') {
    closeFullscreenPreview();
    closeWhatsAppModal();
  }
});

// Auto-save settings
function saveSettingsToStorage() {
  localStorage.setItem('quotepro_export_settings', JSON.stringify(currentSettings));
}

function loadSettingsFromStorage() {
  const saved = localStorage.getItem('quotepro_export_settings');
  if (saved) {
    try {
      const settings = JSON.parse(saved);
      currentSettings = { ...currentSettings, ...settings };
      updateUIFromSettings();
    } catch (e) {
      console.warn('Failed to load saved settings:', e);
    }
  }
}

function updateUIFromSettings() {
  // Update file type selection
  document.querySelectorAll('[data-type]').forEach(card => {
    card.classList.toggle('selected', card.dataset.type === currentSettings.fileType);
  });
  
  // Update export method selection
  document.querySelectorAll('[data-method]').forEach(card => {
    card.classList.toggle('selected', card.dataset.method === currentSettings.exportMethod);
  });
  
  // Update form inputs
  document.getElementById('paperType').value = currentSettings.paperType;
  document.getElementById('paperSize').value = currentSettings.paperSize;
  document.getElementById('customHeader').value = currentSettings.customHeader;
  
  // Update checkboxes
  const signatureCheckbox = document.getElementById('includeSignature');
  const stampCheckbox = document.getElementById('includeStamp');
  const signatureCard = document.getElementById('signatureCard');
  const stampCard = document.getElementById('stampCard');
  
  signatureCheckbox.checked = currentSettings.includeSignature;
  stampCheckbox.checked = currentSettings.includeStamp;
  signatureCard.classList.toggle('checked', currentSettings.includeSignature);
  stampCard.classList.toggle('checked', currentSettings.includeStamp);
  
  // Update sliders
  const sliders = ['headerFontSize', 'bodyFontSize', 'tableFontSize', 'smallFontSize', 'qrSize', 'imageQuality'];
  sliders.forEach(slider => {
    const element = document.getElementById(slider);
    const valueSpan = document.getElementById(slider + 'Value');
    const value = parseInt(currentSettings[slider]) || element.value;
    
    element.value = value;
    const unit = slider.includes('FontSize') ? 'px' : (slider === 'qrSize' ? 'px' : '%');
    valueSpan.textContent = value + unit;
  });
  
  // Show/hide relevant sections based on current settings
  const paperSettings = document.getElementById('paperSettings');
  const imageSettings = document.getElementById('imageSettings');
  const letterheadPreview = document.getElementById('letterheadPreview');
  
  if (currentSettings.fileType === 'png' || currentSettings.fileType === 'jpg') {
    paperSettings.classList.add('hidden');
    imageSettings.classList.remove('hidden');
  } else if (currentSettings.fileType === 'excel') {
    paperSettings.classList.add('hidden');
    imageSettings.classList.add('hidden');
  } else {
    paperSettings.classList.remove('hidden');
    imageSettings.classList.add('hidden');
  }
  
  if (currentSettings.paperType.includes('letterhead')) {
    letterheadPreview.classList.remove('hidden');
  } else {
    letterheadPreview.classList.add('hidden');
  }
  
  // Show/hide export method configurations
  document.getElementById('emailConfig').classList.toggle('hidden', currentSettings.exportMethod !== 'email');
  document.getElementById('whatsappConfig').classList.toggle('hidden', currentSettings.exportMethod !== 'whatsapp');
}

// Load saved settings on page load
window.addEventListener('load', loadSettingsFromStorage);

// Save settings whenever they change
const originalUpdatePreview = updatePreview;
updatePreview = function() {
  saveSettingsToStorage();
  originalUpdatePreview();
};
</script>

</body>
</html>