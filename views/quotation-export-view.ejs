<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quotation Preview</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Arial', sans-serif;
      background: white;
      color: #333;
      line-height: 1.4;
    }
    
    .quotation-container {
      max-width: 210mm;
      margin: 0 auto;
      background: white;
      position: relative;
      min-height: 297mm;
      <% if (exportSettings.paperType && exportSettings.paperType.includes('letterhead')) { %>
      background-image: url('/images/eurotech-letterhead.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      <% } %>
    }
    
    /* ✅ Letterhead overlay for content */
    .content-overlay {
      <% if (exportSettings.paperType && exportSettings.paperType.includes('letterhead')) { %>
      background: rgba(255, 255, 255, 0.95);
      margin: 60px 40px 40px 40px;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      <% } else { %>
      padding: 40px;
      <% } %>
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 3px solid #dc2626;
      padding-bottom: 20px;
    }
    
    .main-title {
      font-size: <%= exportSettings.headerFontSize || '28px' %>;
      font-weight: bold;
      color: #dc2626;
      margin: 0 0 10px 0;
      letter-spacing: 1px;
    }
    
    .vat-number {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }
    
    .quotation-info {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    
    .quotation-details {
      border-left: 4px solid #dc2626;
      padding-left: 15px;
    }
    
    .quotation-details div {
      margin-bottom: 5px;
      font-size: <%= exportSettings.bodyFontSize || '14px' %>;
    }
    
    .quotation-details strong {
      color: #dc2626;
    }
    
    .qr-container {
      text-align: center;
      border: 2px solid #dc2626;
      border-radius: 8px;
      padding: 10px;
      background: white;
    }
    
    .qr-code {
      width: <%= exportSettings.qrSize || '100px' %>;
      height: <%= exportSettings.qrSize || '100px' %>;
      margin-bottom: 5px;
    }
    
    .qr-text {
      font-size: 10px;
      color: #666;
    }
    
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin: 30px 0;
    }
    
    .section {
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: bold;
      color: #dc2626;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 2px solid #dc2626;
    }
    
    .client-info, .project-info {
      font-size: <%= exportSettings.bodyFontSize || '14px' %>;
    }
    
    .client-info div, .project-info div {
      margin-bottom: 8px;
    }
    
    .label {
      font-weight: bold;
      color: #555;
      display: inline-block;
      width: 80px;
    }
    
    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: <%= exportSettings.tableFontSize || '12px' %>;
    }
    
    .items-table th {
      background: #dc2626;
      color: white;
      padding: 12px 8px;
      text-align: center;
      font-weight: bold;
    }
    
    .items-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    
    .items-table tr:nth-child(even) {
      background: #f9f9f9;
    }
    
    .description-cell {
      text-align: left !important;
      max-width: 300px;
    }
    
    .amount-cell {
      text-align: right !important;
      font-weight: bold;
    }
    
    .totals-section {
      margin: 20px 0;
      display: flex;
      justify-content: flex-end;
    }
    
    .totals-table {
      width: 300px;
      font-size: <%= exportSettings.bodyFontSize || '14px' %>;
    }
    
    .totals-table td {
      padding: 8px 12px;
      border-bottom: 1px solid #ddd;
    }
    
    .totals-table .label-cell {
      text-align: right;
      font-weight: bold;
      color: #555;
    }
    
    .totals-table .value-cell {
      text-align: right;
      width: 120px;
    }
    
    .grand-total-row {
      background: #dc2626 !important;
      color: white !important;
      font-weight: bold;
    }
    
    .grand-total-row td {
      border-bottom: none !important;
    }
    
    .list-section {
      margin: 25px 0;
    }
    
    .list-section h3 {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 1px solid #ddd;
    }
    
    .list-items {
      padding-left: 0;
      margin: 0;
    }
    
    .list-items li {
      background: #f8f9fa;
      margin-bottom: 8px;
      padding: 10px 15px;
      border-left: 4px solid #28a745;
      list-style: none;
      font-size: <%= exportSettings.bodyFontSize || '14px' %>;
      position: relative;
    }
    
    .list-items li:before {
      content: counter(list-counter);
      counter-increment: list-counter;
      position: absolute;
      left: -20px;
      top: 10px;
      background: #28a745;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
    }
    
    .scope-list {
      counter-reset: list-counter;
    }
    
    .materials-list {
      counter-reset: list-counter;
    }
    
    .terms-list {
      counter-reset: list-counter;
    }
    
    .warranty-section {
      background: linear-gradient(135deg, #1e40af, #3b82f6);
      color: white;
      padding: 20px;
      margin: 30px 0;
      text-align: center;
      border-radius: 10px;
    }
    
    .warranty-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .warranty-years {
      font-size: 32px;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .warranty-note {
      font-size: <%= exportSettings.smallFontSize || '11px' %>;
      opacity: 0.9;
    }
    
    /* ✅ Signature and Stamp positioning */
    .signature-section {
      margin-top: 40px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }
    
    .signature-box, .stamp-box {
      text-align: center;
    }
    
    .signature-image, .stamp-image {
      max-width: 150px;
      max-height: 80px;
      margin-bottom: 10px;
    }
    
    .signature-line {
      border-top: 1px solid #333;
      width: 200px;
      margin: 0 auto;
      padding-top: 5px;
      font-size: <%= exportSettings.smallFontSize || '11px' %>;
      color: #666;
    }
    
    /* ✅ Print optimizations */
    @media print {
      body {
        margin: 0;
        padding: 0;
      }
      
      .quotation-container {
        box-shadow: none;
        border: none;
        page-break-inside: avoid;
      }
      
      .content-overlay {
        background: transparent !important;
        box-shadow: none !important;
      }
    }
    
    /* ✅ Responsive adjustments */
    @media screen and (max-width: 768px) {
      .quotation-container {
        max-width: 100%;
        margin: 0;
      }
      
      .content-overlay {
        margin: 20px;
        padding: 20px;
      }
      
      .two-column {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .quotation-info {
        flex-direction: column;
        gap: 20px;
      }
      
      .items-table {
        font-size: 10px;
      }
      
      .items-table th,
      .items-table td {
        padding: 6px 4px;
      }
    }
  </style>
</head>
<body>
  <div class="quotation-container">
    <div class="content-overlay">
      
      <!-- Header Section -->
      <div class="header">
        <h1 class="main-title"><%= exportSettings.customHeader || 'QUOTATION FOR WATERPROOFING' %></h1>
        <div class="vat-number">VAT NO: OM1100077623</div>
        
        <div class="quotation-info">
          <div class="quotation-details">
            <div><strong>Quotation No:</strong> <%= quotation.quotation_no %></div>
            <div><strong>Date:</strong> <%= new Date(quotation.tdate).toLocaleDateString('en-GB') %></div>
          </div>
          
          <% if (qrCodeDataURL) { %>
          <div class="qr-container">
            <img src="<%= qrCodeDataURL %>" alt="QR Code" class="qr-code">
            <div class="qr-text">Scan for Quick Access</div>
          </div>
          <% } %>
        </div>
      </div>
      
      <!-- Client and Project Information -->
      <div class="two-column">
        <div class="section">
          <div class="section-title">Client Details</div>
          <div class="client-info">
            <div><span class="label">Name:</span> <%= quotation.client_name || 'N/A' %></div>
            <div><span class="label">Phone:</span> <%= quotation.client_phone || 'N/A' %></div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">Project Information</div>
          <div class="project-info">
            <div><span class="label">Location:</span> <%= quotation.project_location || 'N/A' %></div>
            <% if (quotation.ref_no) { %>
            <div><span class="label">Reference:</span> <%= quotation.ref_no %></div>
            <% } %>
            <% if (quotation.description) { %>
            <div><span class="label">Description:</span> <%= quotation.description %></div>
            <% } %>
          </div>
        </div>
      </div>
      
      <!-- Quotation Items -->
      <% if (items && items.length > 0) { %>
      <div class="section">
        <div class="section-title">Quotation Items</div>
        <table class="items-table">
          <thead>
            <tr>
              <th style="width: 50px;">SL</th>
              <th style="width: 40%;">Description</th>
              <th style="width: 80px;">Qty</th>
              <th style="width: 80px;">Unit</th>
              <th style="width: 100px;">Rate (OMR)</th>
              <th style="width: 120px;">Amount (OMR)</th>
            </tr>
          </thead>
          <tbody>
            <% items.forEach((item, index) => { %>
            <tr>
              <td><%= index + 1 %></td>
              <td class="description-cell"><%= item.description %></td>
              <td><%= parseFloat(item.qty).toLocaleString() %></td>
              <td><%= item.unit %></td>
              <td class="amount-cell"><%= parseFloat(item.rate).toFixed(3) %></td>
              <td class="amount-cell"><%= parseFloat(item.amount).toFixed(3) %></td>
            </tr>
            <% }); %>
          </tbody>
        </table>
        
        <!-- Totals Section -->
        <div class="totals-section">
          <table class="totals-table">
            <tr>
              <td class="label-cell">Total Amount:</td>
              <td class="value-cell">OMR <%= parseFloat(quotation.total_amount || 0).toFixed(3) %></td>
            </tr>
            <% if (quotation.discount && parseFloat(quotation.discount) > 0) { %>
            <tr>
              <td class="label-cell">Discount:</td>
              <td class="value-cell">OMR <%= parseFloat(quotation.discount).toFixed(3) %></td>
            </tr>
            <% } %>
            <% if (quotation.vat_rate && parseFloat(quotation.vat_rate) > 0) { %>
            <tr>
              <td class="label-cell">VAT (<%= parseFloat(quotation.vat_rate).toFixed(2) %>%):</td>
              <td class="value-cell">OMR <%= parseFloat(quotation.vat_amount || 0).toFixed(3) %></td>
            </tr>
            <% } %>
            <% if (quotation.round_off && parseFloat(quotation.round_off) !== 0) { %>
            <tr>
              <td class="label-cell">Round Off:</td>
              <td class="value-cell">OMR <%= parseFloat(quotation.round_off).toFixed(3) %></td>
            </tr>
            <% } %>
            <tr class="grand-total-row">
              <td class="label-cell">Grand Total:</td>
              <td class="value-cell">OMR <%= parseFloat(quotation.grand_total || 0).toFixed(3) %></td>
            </tr>
          </table>
        </div>
      </div>
      <% } %>
      
      <!-- Scope of Work -->
      <% if (scope && scope.length > 0) { %>
      <div class="list-section">
        <h3>Scope of Work</h3>
        <ol class="list-items scope-list">
          <% scope.forEach(item => { %>
          <li><%= item %></li>
          <% }); %>
        </ol>
      </div>
      <% } %>
      
      <!-- Materials -->
      <% if (materials && materials.length > 0) { %>
      <div class="list-section">
        <h3>Materials</h3>
        <ol class="list-items materials-list">
          <% materials.forEach(item => { %>
          <li><%= item %></li>
          <% }); %>
        </ol>
      </div>
      <% } %>
      
      <!-- Terms & Conditions -->
      <% if (terms && terms.length > 0) { %>
      <div class="list-section">
        <h3>Terms & Conditions</h3>
        <ol class="list-items terms-list">
          <% terms.forEach(item => { %>
          <li><%= item %></li>
          <% }); %>
        </ol>
      </div>
      <% } %>
      
      <!-- Warranty Section -->
      <% if (quotation.warranty && quotation.warranty > 0) { %>
      <div class="warranty-section">
        <div class="warranty-title">Warranty</div>
        <div class="warranty-years"><%= quotation.warranty %> YEARS WARRANTY</div>
        <% if (quotation.warranty_note) { %>
        <div class="warranty-note"><%= quotation.warranty_note %></div>
        <% } else { %>
        <div class="warranty-note">WARRANTY ONLY APPLICABLE FOR DONE AREA</div>
        <% } %>
      </div>
      <% } %>
      
      <!-- Signature and Stamp Section -->
      <% if (exportSettings.includeSignature || exportSettings.includeStamp) { %>
      <div class="signature-section">
        <% if (exportSettings.includeSignature) { %>
        <div class="signature-box">
          <img src="/images/eurotech-signature.jpg" alt="Signature" class="signature-image">
          <div class="signature-line">Authorized Signature</div>
        </div>
        <% } %>
        
        <% if (exportSettings.includeStamp) { %>
        <div class="stamp-box">
          <img src="/images/eurotech-stamp.jpg" alt="Company Stamp" class="stamp-image">
          <div class="signature-line">Company Stamp</div>
        </div>
        <% } %>
      </div>
      <% } %>
      
    </div>
  </div>
</body>
</html>