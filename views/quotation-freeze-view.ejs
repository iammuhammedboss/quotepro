<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quotation #<%= quotation.quotation_no %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/images/quotepro-logo.png">
<!-- Update the CSS in quotation-freeze-view.ejs -->
<style>
  body { font-family: 'Outfit', sans-serif; }
  @media print {
    .no-print { display: none !important; }
    body { margin: 0; }
  }
  
  /* ‚úÖ FIXED: Floating menu stops before header */
  .floating-menu {
    position: fixed;
    top: 90px;           /* ‚úÖ Start below the header (header is ~80px) */
    right: 20px;
    z-index: 1000;
    max-height: calc(100vh - 120px);  /* ‚úÖ Don't go beyond viewport */
    overflow-y: auto;    /* ‚úÖ Scroll if too many buttons */
  }
  
  /* ‚úÖ Keep header always on top */
  .topbar {
    position: relative;
    z-index: 1001;      /* ‚úÖ Higher than floating menu */
  }
  
  .action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    text-decoration: none;
    color: #374151;
    font-weight: 500;
  }
  .action-btn:hover {
    border-color: #3b82f6;
    background: #f0f9ff;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(59,130,246,0.3);
  }
  .action-btn.edit { border-color: #10b981; }
  .action-btn.edit:hover { border-color: #10b981; background: #f0fdf4; }
  .action-btn.duplicate { border-color: #f59e0b; }
  .action-btn.duplicate:hover { border-color: #f59e0b; background: #fffbeb; }
  .action-btn.delete { border-color: #ef4444; }
  .action-btn.delete:hover { border-color: #ef4444; background: #fef2f2; }
  .action-btn.export { border-color: #8b5cf6; }
  .action-btn.export:hover { border-color: #8b5cf6; background: #faf5ff; }
</style>
</head>
<body class="bg-gray-50">

<!-- ‚úÖ HEADER WITH PROPER Z-INDEX -->
<div class="bg-red-700 text-white px-6 py-4 flex justify-between items-center no-print topbar">
  <div class="flex items-center gap-4">
    <img src="/images/quotepro-logo-white.png" class="h-10" />
    <div>
      <h1 class="text-xl font-bold">QuotePro ‚Äì View Quotation</h1>
      <p class="text-sm">by Muhammed Boss</p>
    </div>
  </div>
  
  <!-- ‚úÖ NAVIGATION BUTTONS -->
  <div class="flex gap-3">
    <a href="/quotations/search" class="bg-white text-red-700 px-3 py-2 rounded hover:bg-gray-200 text-sm font-medium">
      üîç Search
    </a>
    <a href="/dashboard" class="bg-white text-red-700 px-3 py-2 rounded hover:bg-gray-200 text-sm font-medium">
      üè† Dashboard
    </a>
  </div>
</div>

<!-- ‚úÖ FLOATING MENU - STARTS BELOW HEADER -->
<div class="floating-menu no-print">
  <a href="/quotations/edit/<%= quotation.id %>" class="action-btn edit">
    <span>‚úèÔ∏è</span>
    <span>Edit</span>
  </a>
  <button onclick="duplicateQuotation(<%= quotation.id %>)" class="action-btn duplicate">
    <span>üìã</span>
    <span>Duplicate</span>
  </button>
  <button onclick="deleteQuotation(<%= quotation.id %>)" class="action-btn delete">
    <span>üóëÔ∏è</span>
    <span>Delete</span>
  </button>
<button onclick="exportQuotation(<%= quotation.id %>)" class="action-btn export">
  <span>üì§</span>
  <span>Export</span>
</button>
  <a href="/quotations/create" class="action-btn">
    <span>‚ûï</span>
    <span>New</span>
  </a>
</div>

<!-- üìÑ QUOTATION DOCUMENT -->
<div class="max-w-4xl mx-auto bg-white my-6 shadow-lg print:shadow-none print:my-0">
  
  <!-- ‚úÖ FIXED HEADER WITH SLEEK STYLING -->
  <div class="p-6">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-red-700 mb-3">QUOTATION FOR WATERPROOFING</h1>
      <p class="text-lg font-semibold text-gray-700 mb-6">VAT NO: OM1100077623</p>
      
      <!-- ‚úÖ SLEEK QUOTATION NUMBER AND DATE -->
      <div class="bg-gray-50 rounded-lg p-4 inline-block">
        <div class="grid grid-cols-2 gap-8 text-sm">
          <div class="text-right">
            <span class="font-semibold text-gray-600">Quotation No:</span>
          </div>
          <div class="text-left">
            <span class="text-blue-600 font-bold text-lg"><%= quotation.quotation_no %></span>
          </div>
          <div class="text-right">
            <span class="font-semibold text-gray-600">Date:</span>
          </div>
          <div class="text-left">
            <span class="font-semibold text-lg"><%= new Date(quotation.tdate).toLocaleDateString('en-GB') %></span>
          </div>
        </div>
      </div>
    </div>

    <!-- CLIENT INFORMATION -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="space-y-3">
        <h3 class="text-base font-medium text-gray-800 border-b border-gray-300 pb-1">Client Details</h3>
        <div>
          <p class="text-sm font-medium text-gray-600">Name:</p>
          <p class="text-gray-900"><%= quotation.client_name %></p>
        </div>
        <% if (quotation.client_phone) { %>
        <div>
          <p class="text-sm font-medium text-gray-600">Phone:</p>
          <p class="text-gray-900"><%= quotation.client_phone %></p>
        </div>
        <% } %>
      </div>

      <!-- ‚úÖ ADDITIONAL CONTACTS - Only show if ANY exist -->
      <% 
        const hasAdditionalContacts = quotation.contractor_name || quotation.engineer_name || 
                                     quotation.subcontractor_name || quotation.attention_name;
      %>
      <% if (hasAdditionalContacts) { %>
      <div class="space-y-3">
        <h3 class="text-base font-medium text-gray-800 border-b border-gray-300 pb-1">Additional Contacts</h3>
        
        <% if (quotation.contractor_name) { %>
        <div>
          <p class="text-sm font-medium text-gray-600">Contractor:</p>
          <p class="text-gray-900"><%= quotation.contractor_name %> 
            <% if (quotation.contractor_phone) { %>- <%= quotation.contractor_phone %><% } %>
          </p>
        </div>
        <% } %>

        <% if (quotation.engineer_name) { %>
        <div>
          <p class="text-sm font-medium text-gray-600">Engineer:</p>
          <p class="text-gray-900"><%= quotation.engineer_name %>
            <% if (quotation.engineer_phone) { %>- <%= quotation.engineer_phone %><% } %>
          </p>
        </div>
        <% } %>

        <% if (quotation.subcontractor_name) { %>
        <div>
          <p class="text-sm font-medium text-gray-600">Subcontractor:</p>
          <p class="text-gray-900"><%= quotation.subcontractor_name %>
            <% if (quotation.subcontractor_phone) { %>- <%= quotation.subcontractor_phone %><% } %>
          </p>
        </div>
        <% } %>

        <% if (quotation.attention_name) { %>
        <div>
          <p class="text-sm font-medium text-gray-600">Attention:</p>
          <p class="text-gray-900"><%= quotation.attention_name %>
            <% if (quotation.attention_phone) { %>- <%= quotation.attention_phone %><% } %>
          </p>
        </div>
        <% } %>
      </div>
      <% } %>
    </div>

    <!-- ‚úÖ PROJECT DETAILS - Only show if any exist -->
    <% if (quotation.project_location || quotation.ref_no || quotation.description) { %>
    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
      <h3 class="text-base font-medium text-gray-800 mb-3">Project Information</h3>
      
      <% if (quotation.project_location) { %>
      <div class="mb-2">
        <span class="text-sm font-medium text-gray-600">Location:</span>
        <span class="text-gray-900 ml-2"><%= quotation.project_location %></span>
      </div>
      <% } %>

      <% if (quotation.ref_no) { %>
      <div class="mb-2">
        <span class="text-sm font-medium text-gray-600">Reference:</span>
        <span class="text-gray-900 ml-2"><%= quotation.ref_no %></span>
        <% if (quotation.ref_date) { %>
          (<%= new Date(quotation.ref_date).toLocaleDateString('en-GB') %>)
        <% } %>
      </div>
      <% } %>

      <% if (quotation.description) { %>
      <div class="mb-2">
        <span class="text-sm font-medium text-gray-600">Description:</span>
        <p class="text-gray-900 mt-1"><%= quotation.description %></p>
      </div>
      <% } %>
    </div>
    <% } %>

    <!-- QUOTATION ITEMS -->
    <% if (items && items.length > 0) { %>
    <div class="mb-6">
      <h3 class="text-base font-medium text-gray-800 mb-3">Quotation Items</h3>
      <div class="overflow-x-auto">
        <table class="w-full border-collapse border border-gray-300">
          <thead class="bg-gray-100">
            <tr>
              <th class="border border-gray-300 px-3 py-2 text-left text-sm">SL</th>
              <th class="border border-gray-300 px-3 py-2 text-left text-sm">Description</th>
              <th class="border border-gray-300 px-3 py-2 text-center text-sm">Qty</th>
              <th class="border border-gray-300 px-3 py-2 text-center text-sm">Unit</th>
              <th class="border border-gray-300 px-3 py-2 text-right text-sm">Rate (OMR)</th>
              <th class="border border-gray-300 px-3 py-2 text-right text-sm">Amount (OMR)</th>
            </tr>
          </thead>
          <tbody>
            <% items.forEach((item, index) => { %>
            <tr>
              <td class="border border-gray-300 px-3 py-2 text-center text-sm"><%= index + 1 %></td>
              <td class="border border-gray-300 px-3 py-2 text-sm"><%= item.description %></td>
              <td class="border border-gray-300 px-3 py-2 text-center text-sm"><%= parseFloat(item.qty).toFixed(3) %></td>
              <td class="border border-gray-300 px-3 py-2 text-center text-sm"><%= item.unit %></td>
              <td class="border border-gray-300 px-3 py-2 text-right text-sm"><%= parseFloat(item.rate).toFixed(3) %></td>
              <td class="border border-gray-300 px-3 py-2 text-right text-sm"><%= parseFloat(item.amount).toFixed(3) %></td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      
      <!-- ‚úÖ SUMMARY - RIGHT AFTER ITEMS TABLE -->
      <div class="flex justify-end mt-4">
        <div class="w-full max-w-sm space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="font-medium">Total Amount:</span>
            <span>OMR <%= parseFloat(quotation.total_amount).toFixed(3) %></span>
          </div>
          <% if (quotation.discount > 0) { %>
          <div class="flex justify-between">
            <span class="font-medium">Discount:</span>
            <span>OMR <%= parseFloat(quotation.discount).toFixed(3) %></span>
          </div>
          <% } %>
          <div class="flex justify-between">
            <span class="font-medium">VAT (<%= quotation.vat_rate %>%):</span>
            <span>OMR <%= parseFloat(quotation.vat_amount).toFixed(3) %></span>
          </div>
          <% if (quotation.round_off != 0) { %>
          <div class="flex justify-between">
            <span class="font-medium">Round Off:</span>
            <span>OMR <%= parseFloat(quotation.round_off).toFixed(3) %></span>
          </div>
          <% } %>
          <div class="flex justify-between text-base font-bold border-t border-gray-300 pt-2">
            <span>Grand Total:</span>
            <span>OMR <%= parseFloat(quotation.grand_total).toFixed(3) %></span>
          </div>
        </div>
      </div>
    </div>
    <% } %>

    <!-- ‚úÖ SCOPE OF WORK - Only show if has content -->
    <% 
      const hasScope = scope && scope.length > 0 && scope.some(item => item && item.trim());
    %>
    <% if (hasScope) { %>
    <div class="mb-6">
      <h3 class="text-base font-medium text-gray-800 mb-3">Scope of Work</h3>
      <div class="space-y-2">
        <% scope.forEach((item, index) => { %>
        <% if (item && item.trim()) { %>
        <div class="flex">
          <span class="font-medium text-gray-600 mr-3 text-sm"><%= index + 1 %>.</span>
          <p class="text-gray-900 text-sm"><%= item %></p>
        </div>
        <% } %>
        <% }) %>
      </div>
    </div>
    <% } %>

    <!-- ‚úÖ MATERIALS - Only show if has content -->
    <% 
      const hasMaterials = materials && materials.length > 0 && materials.some(item => item && item.trim());
    %>
    <% if (hasMaterials) { %>
    <div class="mb-6">
      <h3 class="text-base font-medium text-gray-800 mb-3">Materials</h3>
      <div class="space-y-2">
        <% materials.forEach((item, index) => { %>
        <% if (item && item.trim()) { %>
        <div class="flex">
          <span class="font-medium text-gray-600 mr-3 text-sm"><%= index + 1 %>.</span>
          <p class="text-gray-900 text-sm"><%= item %></p>
        </div>
        <% } %>
        <% }) %>
      </div>
    </div>
    <% } %>

    <!-- ‚úÖ TERMS & CONDITIONS - Only show if has content -->
    <% 
      const hasTerms = terms && terms.length > 0 && terms.some(item => item && item.trim());
    %>
    <% if (hasTerms) { %>
    <div class="mb-6">
      <h3 class="text-base font-medium text-gray-800 mb-3">Terms & Conditions</h3>
      <div class="space-y-2">
        <% terms.forEach((item, index) => { %>
        <% if (item && item.trim()) { %>
        <div class="flex">
          <span class="font-medium text-gray-600 mr-3 text-sm"><%= index + 1 %>.</span>
          <p class="text-gray-900 text-sm"><%= item %></p>
        </div>
        <% } %>
        <% }) %>
      </div>
    </div>
    <% } %>

    <!-- ‚úÖ SUMMARY - Only show if no items table was shown -->
    <% if (!items || items.length === 0) { %>
    <div class="border-t border-gray-300 pt-6">
      <div class="flex justify-end">
        <div class="w-full max-w-sm space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="font-medium">Total Amount:</span>
            <span>OMR <%= parseFloat(quotation.total_amount).toFixed(3) %></span>
          </div>
          <% if (quotation.discount > 0) { %>
          <div class="flex justify-between">
            <span class="font-medium">Discount:</span>
            <span>OMR <%= parseFloat(quotation.discount).toFixed(3) %></span>
          </div>
          <% } %>
          <div class="flex justify-between">
            <span class="font-medium">VAT (<%= quotation.vat_rate %>%):</span>
            <span>OMR <%= parseFloat(quotation.vat_amount).toFixed(3) %></span>
          </div>
          <% if (quotation.round_off != 0) { %>
          <div class="flex justify-between">
            <span class="font-medium">Round Off:</span>
            <span>OMR <%= parseFloat(quotation.round_off).toFixed(3) %></span>
          </div>
          <% } %>
          <div class="flex justify-between text-base font-bold border-t border-gray-300 pt-2">
            <span>Grand Total:</span>
            <span>OMR <%= parseFloat(quotation.grand_total).toFixed(3) %></span>
          </div>
        </div>
      </div>
    </div>
    <% } %>

    <!-- ‚úÖ WARRANTY - CAPS FORMAT -->
    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
      <h3 class="text-base font-medium text-gray-800 mb-2">Warranty</h3>
      <p class="text-gray-900 font-bold text-lg"><%= quotation.warranty %> YEARS WARRANTY</p>
      <% if (quotation.warranty_note) { %>
      <p class="text-gray-700 mt-2 text-sm"><%= quotation.warranty_note %></p>
      <% } %>
    </div>

  </div>
</div>

<!-- DELETE CONFIRMATION MODAL -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 no-print">
  <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
    <div class="text-center">
      <div class="text-6xl mb-4">‚ö†Ô∏è</div>
      <h2 class="text-xl font-bold mb-2">Delete Quotation</h2>
      <p class="text-gray-600 mb-4">Are you sure you want to delete:</p>
      <div class="bg-gray-50 p-3 rounded mb-4">
        <p class="font-medium"><%= quotation.quotation_no %></p>
        <p class="text-sm text-gray-600"><%= quotation.client_name %></p>
        <p class="text-sm text-gray-600">OMR <%= parseFloat(quotation.grand_total).toFixed(3) %></p>
      </div>
      <p class="text-red-600 text-sm mb-6">This action cannot be undone.</p>
      <div class="flex gap-3">
        <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
          Cancel
        </button>
        <button onclick="confirmDelete(<%= quotation.id %>)" class="flex-1 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
          Delete Quotation
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Duplicate Quotation
function duplicateQuotation(id) {
  if (confirm('Duplicate this quotation with a new quotation number?')) {
    fetch(`/quotations/duplicate/${id}`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          window.location.href = `/quotations/edit/${data.newId}`;
        } else {
          alert('Error duplicating quotation: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(err => {
        console.error('Duplicate error:', err);
        alert('Error duplicating quotation');
      });
  }
}

// Export Quotation (placeholder for now)
function exportQuotation(id) {
  // Redirect to the new export interface
  window.location.href = `/quotations/export/${id}`;
}

// Delete Quotation
function deleteQuotation(id) {
  document.getElementById('delete-modal').classList.remove('hidden');
  document.getElementById('delete-modal').classList.add('flex');
}

function closeDeleteModal() {
  document.getElementById('delete-modal').classList.add('hidden');
  document.getElementById('delete-modal').classList.remove('flex');
}

function confirmDelete(id) {
  fetch(`/quotations/${id}`, { method: 'DELETE' })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        window.location.href = '/quotations/search';
      } else {
        alert('Error deleting quotation: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(err => {
      console.error('Delete error:', err);
      alert('Error deleting quotation');
    });
}
</script>

</body>
</html>